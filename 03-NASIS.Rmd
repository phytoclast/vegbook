# Vegetation Databases
## Potential Data Schema for Vegetation Data

The purpose of a vegetation inventory is to characterize a general vegetation concept. For this, a logical vegetation schema is required. Vegetation data can be arranged hierarchically from sampling units dictated by a protocol (individual plant records), demographic summary of plant species cohorts occupying a unit of land (plot composition), and a whole structural summary of the plot, which in turn represent a larger inference area, stand, or vegetation classification concept.

Most vegetation types share the same set of measurable properties, but different priorities can be placed on properties depending on land use. A schema should be flexible enough to allow for degrees of uncertainty of the entities being populated. Through a combination of partial and complete records, a higher vegetation concept can be described. At minimum there should be enough data populated for the plot record to be classified to a higher concept. The attributes from each record can also be summarized to characterize that higher concept.

Each attribute from individual plant to generalized vegetation concept can be manifest at each level of abstraction. Attributes of individual plant record becomes statistical summaries of those same attributes when considering the whole plot. Not all protocols involve individual plant records, but instead may employ ocular estimates to estimate plot composition directly. Statistics are grouped by the entity name (taxon or habit) and usually partitioned into cohorts based on one or more of the measured properties (size/age classes). There are two different types of plant demographic statistics summarized. The first type is the summary of attributes among individuals in a cohort, and the second type is a summary quantifying the attribute relative to a land area. For example, mean height is meaningful only as a summary per individuals. Mean crown width and quadratic mean diameter may also be  meaningful on a per individual basis, but these same properties are manifest as plant abundance in terms of percent canopy cover and basal area (stem area per land area), respectively.

At the highest level of abstraction (structure), named entities are dissolved, cohorts may be concatenated into fewer groups, and the summaries are more generalized structural summaries can sometimes be calculated as aggregated attributes from the composition tables, but some attributes can only be estimated independently of the composition data (e.g. total canopy closure, total canopy gap). At the plot level, rather than species name or habit, the named entity reflects a summary of the overall dominant composition (association name) or structure (structural label such as “forest”, “shrubland”, or “grassland”)

For the sake of data analysis, all possible statistics that summarize species composition should be available in the same table, even if variations exist in the protocols used to get these statistics. Where different protocols or sampling areas are used to account for these statistics in the same site, it is better practice to establish independent plot records specifying the differences than to maintain redundant tables.

Ultimately all the attributes in point data summarize the essential attributes of the modular ecological state concept. A modular ecological state could be moved, split, or merged with other such concepts and its underlying attributes would recalculate. There should be no concern for renumbering or disrupting a nested structure of the state-and-transition model. Any causal relationship posed by the end user between any two modular ecological state box would be inferred dynamically (or at least a filter a list of possible agents of change) from the contrast among their corresponding attributes.

*1)	Individual Plant Records (stem/point/quadrat)*

  * a)	Entity (categorical data)
    * i)	Species
    * ii)	Higher Taxon
    * iii)	Habit/Growth Form/Plant Type/Functional Group
  * b)	Single Plant Attributes (numeric data)
    * i)	Plant Height
    * ii)	Plant Stem Diameter
    * iii)	Plant Crown Width
    * iv)	Foliar Hit or Plant Total Leaf Area
    * v)	Quadrat Biomass or Plant Total Biomass
    * vi)	Plant Age
    * vii)	Plant Growth Rate
  * c)	Cohort Membership (categorical data - demographic partition of entity)
    * i)	Cohort Label
  * d)	Cohort Criteria (numeric data - grouping based on an attribute)
    * i)	Height Class
    * ii)	Diameter Class
    * ii)	Age Class
    
*2)	Stand Composition Data Table*

  * a)	Entity
    * i)	Species
    * ii)	Higher Taxon
    * iii)	Habit/Growth Form/Plant Type/Functional Group
  * b)	Attributes (Summarized)
    * i)	Plant Height Statistics
    * ii)	Stem Diameter Statistics 
    * iii)	Crown Width Statistics
    * iv)	Age Statistics
  * c)	Cohort Membership
    * i)	Cohort Label
  * d)	Cohort Criteria
    * i)	Height Class
    * ii)	Diameter Class
    * iii)	Age Class
  * e)	Abundance (attributes per unit area)
    * i)	Frequency
    * ii)	Stem Density
    * iii)	Stem Basal Area
    * iv)	Canopy Cover
    * v)	Foliar Cover
    * vi)	Biomass
    * vii)	Productivity

*3)	Total Stand Attributes Table*

  * a)	 Entity
    * i)	Community Name (association/common name)
    * ii)	Community Structure Label
    * iii)	Community Dominant Species (short list)
  * b)	Aggregate Attributes (derived from stand composition data)
    * i)	Stand Species Richness
    * ii)	Stand Height Statistics
    * iii)	Stand Diameter Statistics
    * iv)	Stand Total Basal Area
    * v)	Stand Canopy Closure
    * vi)	Stand Total Tree Canopy Cover
    * vii)	Stand Total Shrub Canopy Cover
    * viii)	Stand Total Herb Canopy Cover
    * ix)	Stand Total Nonvascular Cover
    * x)	Stand Total Vegetation Canopy Cover (Inverse Canopy Gap)
    * xi)	Stand Leaf Area Index (total foliar cover of all strata)
    * xii)	Stand Total Stand Biomass (aboveground/belowground)
    * xiii)	Stand Productivity
    * xiv)	Stand Age
  * c)	Necromass Attributes (independent of stand composition data)
    * i)	Snag Density (size class/decay class)
    * ii)	Down Woody Debris Statistics (size class/decay class)
    * iii)	Leaf Litter Cover
  * d)	Plot metadata
    * i)	Protocol
    * ii)	Plot size
    * iii)	Transect length (number of points)
    * iv)	Inventory intensity class (but specifications should speak for themselves)
    * v)	Taxonomic completeness

    
![Figure 2. Potential data Schema for vegetation data )](static-figures/schema.png)

## VegLog MS Access Database

Relevé plot data is collected in a way that optimizes efficiency and quality control in the field, but is not suitable for [NASIS (National Soil Information System)](https://www.nrcs.usda.gov/resources/guides-and-instructions/nasis-user-guides) in its current form.  Field collection datasheet allows cover data for up to 4 strata to be recorded in a single row, ensuring that an observed plant taxon need only be listed once per plot. This avoids the need to recursively scan for the same taxon multiple times to ensure that the occupancy of each stratum is recorded appropriately. However, NASIS records each taxon-stratum incidence as independent rows. Additionally, Relevé protocol [@dnr2013handbook] is based on [SI (International System of Units)](https://www.nist.gov/programs-projects/international-system-units-si) as are all soil pedon description protocols, but NASIS currently only allows for legacy protocols based on [USC (US customary)](https://www.nist.gov/pml/owm/approximate-conversions-metric-us-customary-measures) units to be entered. Prior to entering data into NASIS (National Soil Information System), it is recommended that it first be entered into the custom MS Access Database **VegLog**.

- Select user name.

![Startup Form](static-figures/veglog1.png)

### Site data {-}

![Observed Sites](static-figures/veglog2.png)

- Enter GSP coordinates in decimal degrees of each plot location. If need be, enter degrees, minutes, seconds at the bottom to auto calculate decimal degrees in current record.

### Taxon data {-}

![Site (observed plants tab)](static-figures/veglog3.png)

- Enter species list. Use genus and specific epithet autolookup fields.

- Enter all the cover values of each of 4 strata. The default heights are 0-0.5, 0.5-5, 5-15, and 15+ meters, but this can be adjusted.

- Enter basal area of taxon based on variable radius plot as determined by prism or angle gauge. May need to adjust BAF (basal area factor) if not USC BAF base 10. SI BAF 2 is also supported.

- Enter the maximum and minimum of observed live crown height of dominant (highest) stratum of the taxon in meters. After entering all the data for the plot, use the button to auto populate these heights to their appropriate height within stratum. Live crown heights can also be manually specified for the lower strata in the additional columns, but paper forms may not have the extra columns, and it is relatively redundant information (presence in highest stratum demonstrates capability of taxon to occupy full height range any lower stratum also present).

- Enter the maximum and minimum diameters (DBH - diameter at breast height) in centimeters of trees observed to fall within the basal area plot (variable radius plot).

### Other Vegetation details and processing {-}

![Site (vegetation tab)](static-figures/veglog4.png)

- Enter total cover for each stratum (if zero, leave blank).

- **Synonymize Plant Taxa** (assigns PLANTS symbols).

- **Aggregate Cover** to show current estimate of aggregate cover, then **Transform Overstory** and **Transform Understory** to adjust individual cover values to be more consistent with observed whole stratum cover.

### Reports (conversions to NASIS) {-}

![Site (Reports tab)](static-figures/veglog5.png)

- **Paste to NASIS** to convert to USC units and serialize taxon by stratum data.


## Vegetation Plot Object in NASIS

Tips: Row entries save in the local database when you advance to the next record. But if in last new row, the record needs to be saved manually with the end edit green check button at bottom of screen, prior to saving all records (upload) to the national database. After saving to the national database, remember to check in the records to unlock them for future edits. You may rearrange the columns by dragging them to reflect the datasheet that you are copying from.

-	Create new record in **Vegetation Plot** table.

-	Assign plot record to the appropriate user **Site ID** and **observation date**, or create new observation if different from pedon observation date.

-	Name user **user vegplot id** the same as site id, but may append suffix of P to indicate plot, or T to indicate transect, given that the observation dates can differ and require different observation records.

-	There are two ways to enter the species composition records: 1. By column (faster); by row.

-	Enter species as it appears on your datasheet. You may either enter the full Latin name or enter the [PLANTS](https://plants.usda.gov/) symbol if you’ve conducted a lookup query in the source database where data was initially entered.

    -	If entering by column, proceed with entering each name, vertically before entering the data for other columns, using the down arrow to advance to the next new record. The same species may be entered multiple times. Take care that the sort order of the rows remains consistent with the order on your datasheet to ensure that data entered by column remains correlated properly (not a problem if completing each column of each new row horizontally). You may sort by any of the columns by pressing on the column name; to restore original order of entry, sort by Rec ID on the far right.

-	Select the appropriate growth habit in the **Plant Type Group**. Every species should have a default value established that is the same regardless of the stature in existing plot record; see regional ecologist if you need a list of accepted values. For by column entry, most entries require only first one or two letters of the growth form, followed by enter, then arrow down.

-	Select the appropriate Plant Nativity, based on whether a taxon is considered native to the state where the inventory was recorded. See [BONAP](http://bonap.net/tdc) to determine the nativity status. Some species are native to North America, but are considered “adventive” to a state on the BONAP website; select “introduced” in these instances. Select “unknown” for species with both native and introduced genotypes (e.g. _Phalaris arundinacea_).

-	Enter all the Species **Canopy Cover Percent** to the nearest whole percent. If rounding down to zero, you need to select the **Spp Trace Amount Flag** checkbox. Advance to each record using the down arrow. For greater precision to the neared 0.1%, use **akstratumcoverclasspct**. If you recorded using the cover classes, **speciescancovclass** is also acceptable. All these cover options will be converted to strictly numeric data when analyzed later.

-	For each species stratum entry, there is a **Height Class Lower Limit** and **Height Class Upper Limit**. These are typically based on federal government vegetation standards [@usnvc2008] lower stratum heights converted from meters to feet: 0 to 1.6; 1.6 to 16.4; 16.4 to user define limits for upper strata (e.g. 16.4 to 49.2 and 49.2 to 98.4). To ensure data integrity of original SI units, do not round to the nearest whole number.

-	Enter Live **Canopy Ht Bottom** and **Live Canopy Ht Top** the height range of the typical crowns for current taxon within current stratum. The top height is generally going to be within the upper and lower range for the stratum. The canopy bottom can range below the range of the stratum, because the stratum only reflects the top heights of plants in that stratum, while the lowest live branches can extend below that height. Often this is only recorded for the uppermost stratum of the taxon, as it can be safely assumed that the live canopy of lower strata can encompass the whole range of the stratum over time. Enter as feet, but to ensure data integrity if recorded in the field as SI units, do not round to the nearest whole number.

-	Enter **Overstory DBH Minimum** and **Overstory DBH Maximum** as inches converted from centimeters. To ensure data integrity of original recorded SI units, do not round to the nearest whole number. Typically, this is only recorded for trees in the uppermost stratum for the taxon.

-	Enter **Basal Area by Spp**. This is typically based on tree count with a prism, multiplied by a factor. If using a USC factor ten prism, the count is multiplied by ten and entered as is. If using an SI factor two prism, you must convert it to USC; this is less common due to a shortage of SI equipment domestically. To ensure data integrity if originally recorded using SI units, do not round to the nearest whole number.

-	Other remaining columns are optional **Vegetation Strata Level** only recognizes overstory and understory. If using this column, the overstory strata are those more than 5 m or 16.4 ft. **Spp DBH Average** is really the quadratic mean diameter if you use a prism to select trees to measure. You can enter each tree diameter individually, but this would need to go into the **Plot Tree Inventory** table.



**NASIS Tables**

Elements colored by observation intensity level:
<span style="color: red">Low Intensity,</spand>
<span style="color: green">Medium Intensity,</spand>
<span style="color: blue">High Intensity,</spand>
<span style="color: gray">Optional.</spand>

* **1. Site** (Plot Area to be moved to vegetation plot)
  * <span style="color: red">User Site ID</span>
  * <span style="color: red">WGS84 Latitude DD (degrees)</span>
  * <span style="color: red">WGS84 Longitude DD (degrees)</span>
  * <span style="color: red">Elevation (m)</span>
  * <span style="color: red">Slope Gradient (%)</span>
  * <span style="color: red">Aspect (degrees)</span>
  * <span style="color: red">State</span>
  * <span style="color: red">County Area Type ID</span>
  * <span style="color: red">MLRA</span>
  * <span style="color: red">Hillslope Profile/Geomorphic Component Hills/Geomorphic Component Flats/Geomorphic Component Terraces/Geomorphic Component Mountains</span>
  * <span style="color: red">Veg Plot Size (m²)</span>
  * <span style="color: red">**a. Site Observation**</span>
    * <span style="color: red">Data Collector</span>
    * <span style="color: red">Observation Date</span>
    * <span style="color: red">Earth Cover Kind One/Earth Cover Kind Two</span>
    * <span style="color: gray">[if available] Ecological State ID</span>
    * <span style="color: gray">[if available] Ecological State Name</span>
    * <span style="color: gray">[if available] Community Phase ID</span>
    * <span style="color: gray">[if available] Community Phase Name</span>
    * <span style="color: gray">[if available] Plant Association Name (may not have enough characters)</span>
  * <span style="color: red">**b. Site Geomorphic Description**</span>
    * <span style="color: red">Geomorphic Feature</span>
  * <span style="color: red">**c. [if available] Site Ecological Site History**</span>
    * <span style="color: red">Ecological Site</span>

* **2. Vegetation Plot**
  *	<span style="color: gray">[if site lacks pedon] Assoc (Associate User Pedon ID)]</span>
  * <span style="color: gray">[optional] Vegetation Plot Name</span>
  * <span style="color: green">Total Overstory Canopy Cover Pct (% trees only)</span>
  * <span style="color: green">Total Overstory Canopy Cover Pct (% trees only)</span>
  * <span style="color: green">Total Canopy Cover Pct (% all plants)</span>
  * <span style="color: green">Basal Area Factor</span>
  * <span style="color: green">Total BA (m²/ha --> ft²/ac)</span>
  * <span style="color: blue">Hard Tree Snag Density (per ha --> per acre)</span>
  * <span style="color: blue">Soft Tree Snag Density (per ha --> per acre)</span>
  * <span style="color: red">**a. Plot Plant Inventory**: Cover by _dominant_ or </span> <span style="color: green">_all_ species by stratum</span>
    * <span style="color: red">Plant (USDA Plants Symbol)</span>
    * <span style="color: red">Plant Type Group</span>
    * <span style="color: gray">Sociability Class</span>
    * <span style="color: red">Canopy Cover Pct (% --> cover class)</span>
    * <span style="color: red">Height Class Lower Limit (m --> ft)</span>
    * <span style="color: red">Height Class Upper Limit (m --> ft)</span>
    * <span style="color: green">Basal Area by Spp (m²/ha --> ft²/ac)</span>
    * <span style="color: green">Overstory DBH Minimum (cm --> inch)</span>
    * <span style="color: green">Overstory DBH Maximum (cm --> inch)</span>
    * <span style="color: blue">Live Canopy Ht Bottom (m --> ft)</span>
    * <span style="color: blue">Live Canopy Ht Top (m --> ft)</span>
    * <span style="color: blue">**a1. [optional] Subplot Plant Details**</span>
      * <span style="color: blue">[optional] Subplot Number (serial)</span>
      * <span style="color: blue">[optional] Subplot Size (m²)</span>
      * <span style="color: blue">[optional] Number of Stems (count)</span>
      * <span style="color: blue">[optional] Average Stem Diameter (cm --> inch; actual measurement not important if represented as diameter or height class in parent table)</span>
  * <span style="color: blue">**b. Plot Species Basal Area**</span>
    * <span style="color: blue">Plant (USDA Plants Symbol)</span>
    * <span style="color: blue">Plant Type Group</span>
    * <span style="color: blue">Plant Nativity</span>
    * <span style="color: blue">Basal Area Factor</span>
    * <span style="color: blue">Nmbr of Trees In</span>
    * <span style="color: blue">Spp BA (m²/ha --> ft²/ac)</span>
    * <span style="color: blue">**b1. Basal Area Trees Counted**</span>
      * <span style="color: blue">Tree ID Nmbr (serial)</span>
      * <span style="color: blue">Tree Height (m --> ft)</span>
      * <span style="color: blue">DBH (cm --> inch)</span>
  * <span style="color: blue">**c. Plot Species Site Index**</span>
    * <span style="color: blue">Plant (USDA Plants Symbol)</span>
    * <span style="color: blue">Site Index Curve (use 999 for unknown)</span>
    * <span style="color: blue">Nmber of Trees Counted (count)</span>
    * <span style="color: blue">**c1. Plot Tree Site index Details**</span>
      * <span style="color: blue">Tree ID Nmbr (serial)</span>
      * <span style="color: blue">Tree Height (m --> ft)</span>
      * <span style="color: blue">DBH (cm --> inch)</span>
      * <span style="color: blue">Growth Rings (count)</span>
      * <span style="color: blue">Growth Ring Count Height (m --> ft)</span>
      * <span style="color: blue">Tree Age (years)</span>
      * <span style="color: blue">Crown Class</span>
  * <span style="color: blue">**d. Vegetation Transect**</span>
    * <span style="color: blue">Veg Transect ID</span>
    * <span style="color: blue">Total Nmbr of Points Sampled (count)</span>
    * <span style="color: blue">Transect Length (m --> ft)</span>
    * <span style="color: blue">[Optional] Nmbr of Dbl Samp Quadrats Clipped (count)</span>
    * <span style="color: blue">[Optional] Total Harvest Annual Prod (kg/ha or g/m² --> lb/acre)</span>
    * <span style="color: blue">**d1. Vegetation Transect Plant Summary**</span>
      * <span style="color: blue">Plant (USDA Plants Symbol for functional group if not to species)</span>
      * <span style="color: blue">Plant Type Group</span>
      * <span style="color: blue">Plant Nativity</span>
      * <span style="color: blue">Nmbr of Species Foliar Cover Hits (count)</span>
      * <span style="color: blue">Foliar Cover Pct Line Int (%)</span>
      * <span style="color: blue">[Optional] Plant Prod Quadrat Shape</span>
      * <span style="color: blue">[Optional] Plant Prod Quadrat Size (m² --> ft²)</span>
      * <span style="color: blue">[Optional] Total Clipped Wt Fresh (kg/ha or g/m² --> lb/acre)</span>
      * <span style="color: blue">[Optional] Total Clipped Wt Air Dry (kg/ha or g/m² --> lb/acre)</span>
    * <span style="color: blue">**d2. Transect Ground Surface Cover**</span>
      * <span style="color: blue">Ground Surface Cover Type</span>
      * <span style="color: blue">Nmbr of Points (count)</span>
      * <span style="color: blue">Ground Cover Pct Points (%)</span>
  * <span style="color: gray">**e. Plot Disturbance**</span>
    * <span style="color: gray">Disturbance Type</span>
    * <span style="color: gray">Frequency</span>
    * <span style="color: gray">Disturbance Impact</span>
      
### NASIS Data Entry

1.	Establish Site record directly in site table the User Site ID and GPS coordinates.
2.	Establish date within Site Observation child table.
 ![Site > Site Observation child table](static-figures/TSiteObs.png)
 
Establish VegPlot record directly in Vegetation Plot table, entering User Plot ID and select the appropriate Site Observation (seen as User Site ID and Date). Enter any other values that might be common among the plots.

![Vegetation Plot table](static-figures/TVegPlot.png)

 
Open Plot Plant Inventory child table and establish the species list. Rather than scrolling to find all the required columns, proceed to one of the following forms. 

![Vegetation Plot >  Plot Plant Inventory child table](static-figures/TVegPlants.png)

Open ESI Site-Releve form and populate the site and plot meta data. This form requires that both Site and Vegetation Plot records be checked out and editable. If the Site table is already populated, there is no need to check out the record. 

![ESI Site-Releve form](static-figures/FSiteReleve.png)
 
Instead, use one of the simpler forms that only accesses data from Vegetation Plot. 
Use ESI Releve for simple species cover by stratum.

![ESI Releve-Simple form](static-figures/FReleveSimple.png)
 
Use ESI Releve Structure to fill out plot details other than species composition.

![ESI Releve-Structure form](static-figures/FReleveStructure.png)
 
Use ESI Releve-Trees-All to enter basal area tree diameters and site index.

![ESI Releve-Trees-All form](static-figures/FReleveTrees.png)
 
Use ESI Releve-Transect

 ![ESI Releve-Transect form](static-figures/FReleveTransect.png)

Optionally, create a record for Site Association and name it the same as the relevant NASIS Project. Populate the Site child table with all the sites observed for the project. If this is an Ecological Site Verification project, you may opt to include sites observed for  previous projects if they have plot data relevant for integration with the current project.
 

![Site Association Table](static-figures/TSass.png)

### NASIS Data Extraction

1.	Query for Ecological Site Verification Projects in your Region and load them into your local database.
 
 ![Project by Project Substype, Office, and User Project ID query](static-figures/QProject.png)

2. Get list of project user ids in R by running this script.
```{r warning=FALSE, message = FALSE, eval=FALSE}
library(soilDB)
projects <- soilDB::get_projectmapunit_from_NASIS(SS=F)
projects <- subset(projects, select=c(projectiid, uprojectid, projectname)) |> unique()
paste(projects$uprojectid, collapse = " ")
```
Just copy the set of project IDs in the RStudio console without the quotes.
 ![RStudio Console](static-figures/RStudio.png)


3.	Run this query in 3-4 stages to get data from all related tables. Query for sites and site associations using *SiteObs by list of Site Associations*, run nationally.

  ![](static-figures/Qnational.png)
  
  ![SiteObs by list of Site Associations query](static-figures/QSass1.png)

4.	Get the vegplots, run nationally.

  ![SiteObs by list of Site Associations query](static-figures/QSass2.png)
 
5.	Get the pedons if needed, run nationally.

  ![SiteObs by list of Site Associations query](static-figures/QSass3.png)
 
6.	Run local query for all objects.

  ![](static-figures/QLocal.png)
  
  ![SiteObs by list of Site Associations query](static-figures/QSass4.png)
  
```{r warning=FALSE, message = FALSE, eval=FALSE}
#Site data  
siteass <- get_site_association_from_NASIS(SS=F)
sites <- get_site_data_from_NASIS_db(SS=F)
#Vegetation data
veg.raw <- soilDB::get_vegplot_species_from_NASIS_db(SS=F)
vegplot <- soilDB::get_vegplot_from_NASIS_db(SS=F)
```

Data are now available in R environment for quality control and analysis.

## Getting data into EDIT

```{r warning=FALSE, message = FALSE, eval=FALSE}
#remotes::install_github("ncss-tech/soilDB", dependencies = FALSE)

library(soilDB)

#1. Run queries in NASIS for projects ----
projects <- get_projectmilestone_from_NASIS(SS=F)
projects <- subset(projects, select=c(uprojectid, projectname)) |> unique()
paste(projects$uprojectid, collapse = " ")

#2. Run queries in NASIS for Site Association ----
siteass <- get_site_association_from_NASIS(SS=F)

sites <- get_site_data_from_NASIS_db(SS=F)

#3. Run queries in NASIS to capture all vegplots related to site associations ----
library(dplyr)
library(vegnasis)

veg.raw <- soilDB::get_vegplot_species_from_NASIS_db(SS=F)
vegplot <- soilDB::get_vegplot_from_NASIS_db(SS=F)

#4. Combine STM attributes ----
vegsite <- subset(sites, select = c(siteiid, site_id, siteobsiid, ecositeid,ecositenm,ecostatename,commphasename)) |>
  left_join(subset(vegplot, select = c(siteobsiid, vegplotid, obsintensity)), relationship = "many-to-many") |> unique()

#5. Analyse plot structure and composition ----
veg <- vegnasis::clean.veg(veg.raw)
veg$taxon <- harmonize.taxa(veg$taxon, fix = TRUE, sensu = "usda")
veg <-  veg |> fill.type.df() |> fill.hts.df()

veg.structure <- get.structure(veg)
veg.ass <- get.assoc(veg)

veg.over <- veg |> subset(ht.max > 5) |> group_by(plot, taxon, type) |> summarise(cover=cover.agg(cover))
veg.under <- veg |> subset(ht.max <= 5) |> group_by(plot, taxon, type) |> summarise(cover=cover.agg(cover))


#5. Summary Plant Composition Table for export as spreadsheet for pasting into EDIT ----
Veg.group <- veg |> left_join(vegsite, by=join_by(plot==vegplotid),relationship = "many-to-many") |> subset(!is.na(plot)) |>
  #Create a group
  mutate(group = paste(ecositeid, ecositenm, ecostatename, commphasename))

EDITsum <- vegnasis::summary.ESIS(Veg.group, group = 'group',normalize = TRUE, lowerQ = 0, upperQ = 1, breaks = c(0.5,5,12), forEDIT = TRUE) |>
  #Round up for high cover
  mutate(cover.High=ifelse(cover.High < 0.1,0.1,cover.High)) |>
  #Override plant type
  mutate(type = case_when(symbol %in% 'COCAC3' ~ 'Forb/Herb',
                          symbol %in% 'CASP14' ~ 'Forb/Herb',
                          symbol %in% 'PRSU3' ~ 'Shrub/Subshrub',
                          symbol %in% '2LICHN' ~ 'Biological Crusts',
                          symbol %in% 'Orchidaceae' ~ 'Forb/Herb',
                          TRUE ~ type),
         #Set sort order based on type
         type.top = case_when(type %in% 'Tree' ~ 1,
                              type %in% 'Shrub/Subshrub' ~ 2,
                              type %in% 'Vine/Liana' ~ 3,
                              type %in% 'Grass/grass-like (Graminoids)' ~ 4,
                              type %in% 'Forb/Herb' ~ 5,
                              type %in% 'Fern/fern ally' ~ 6,
                              type %in% 'Nonvascular' ~ 7,
                              type %in% 'Biological Crusts' ~ 8,
                              TRUE ~ 9)) |> arrange(group,overstory,type.top, desc(taxon.cover), taxon)

#Unit conversion is optional because EDIT allows either SI or USC data entry.
EDITsum.USC <- EDITsum |> mutate(Bottom = ht.USC(Bottom), Top = ht.USC(Top), dbh.Low=dbh.USC(dbh.Low), dbh.High=dbh.USC(dbh.High), BA.Low=BA.to.USC(BA.Low), BA.High=BA.to.USC(BA.High))
write.csv(EDITsum, 'EDITsum.csv', row.names = FALSE, na = "")

#6. EDIT Stand Structure ----

veg.str <- summary.crown.thickness(veg, breaks = c(0.15,0.3,0.6,1.4,4,12,24,37)) |> structure.fill.zero() |> subset(type %in% c('tree', 'shrub/vine', 'grass/grasslike',  'forb'))

veg.str <- veg.str |> left_join(vegsite, by=join_by(plot==vegplotid),relationship = "many-to-many") |> subset(!is.na(plot)) |>
  #Create a group
  mutate(group = paste(ecositeid, ecositenm, ecostatename, commphasename))


veg.str.pct <- veg.str |> group_by(group, type, stratum, stratum.label, bottom, top) |>
  summarise(X25 = quantile(Cover, 0.25),
            X50 = quantile(Cover, 0.5),
            X75 = quantile(Cover, 0.75))

write.csv(veg.str.pct, 'veg.str.pct.csv', row.names = FALSE, na = "")
```

Find your comma delimited spreadsheet, 'EDITsum.csv', open and then copy and paste the relevant portions into EDIT. Be cognizant of whether EDIT is set on SI (metric) units or USC (US Customary or English) units. Vegnasis package analyses data in SI units, but you can optionally convert all data to USC prior to exporting it as a spreadsheet. Or you can set EDIT to accept SI units.

![Copy from Spreadsheet just the portion related to this community, either overstory or understory.](static-figures/ExcelCopy.png)
  
    
![Paste into EDIT into the correct Forest Overstory or Understory Species composition table](static-figures/EDITPaste.png)

## Summarizing DSP Projects

The following script demonstrates a possible workflow for summarizing the vegetation data from a Dynamic Soil Properties (DSP) project. 


```{r warning=FALSE, message = FALSE, eval=TRUE}
#remotes::install_github("ncss-tech/soilDB", dependencies = FALSE)
library(vegnasis)
library(soilDB)

#Create conditional rounding functions
condRound10 <- function(x){
  x <- ifelse(x < 0.05, 0, ifelse(x < 10, round(x, 1), round(x,0)))
  x <- as.character(x)
  return(x)
}
condRound1 <- function(x){
  x <-  ifelse(x < 0.05, 0, ifelse(x < 1, round(x, 1), round(x,0)))
  x <- as.character(x)
  return(x)
}


#Load Demo Data 
siteass <- vegnasis::siteass20250414
sites <- vegnasis::sites20250414
veg.raw <- vegnasis::veg.raw20250414
vegplot <- vegnasis::vegplot20250414

#To use your own data, remove # below
# siteass <- get_site_association_from_NASIS(SS=F)
# sites <- get_site_data_from_NASIS_db(SS=F)
# veg.raw <- soilDB::get_vegplot_species_from_NASIS_db(SS=F)
# vegplot <- soilDB::get_vegplot_from_NASIS_db(SS=F)
    
#narrow to a project (user site association id)
thesesites <- subset(siteass, usiteassocid %in% 'DSP-F094AB019MI-2024')
sites <- subset(sites, usiteid %in% thesesites$usiteid)

landuse <- data.frame(siteobsiid=sites$siteobsiid, landuse = sites$commphasename)
landuse <- landuse |> left_join(data.frame(siteobsiid=vegplot$siteobsiid, plot = vegplot$vegplotid)) |> subset(!is.na(plot) & !is.na(landuse))
veg <- clean.veg(veg.raw)|> subset(!is.na(taxon)) 
veg <- veg |> inner_join(landuse)

veg <- veg |> mutate(type=NA) |> fill.type.df() |> fill.hts.df()
veg <- veg |> mutate(taxon = harmonize.taxa(veg$taxon, fix = TRUE, sensu = "usda"))

#Get vegetation Structure ----
veg.str <- veg |> get.structure(simple = TRUE)



veg.str <- veg.str |> inner_join(landuse)
veg.str.long <- tidyr::pivot_longer(veg.str, c(tree,shrub,herb,moss,ht.max))
veg.str.summary <- veg.str.long |> group_by(landuse, name) |> summarise(Low = round(quantile(value,0.05),1),
                                                                 RV = round(mean(value),1),
                                                                 High = round(quantile(value,0.95),1))

veg.str.wide <- tidyr::pivot_wider(veg.str.summary, names_from = landuse, values_from = c(Low,RV,High)) |> as.data.frame()

library(kableExtra)
library(knitr)
#kableextra ----
df2 <- veg.str.summary |> group_by(landuse) |> arrange()
df2$name <- factor(df2$name, levels = c('ht.max','tree','shrub','herb','moss'))
df2 <- df2[order(df2$landuse,df2$name),]
df2 |>
  knitr::kable(row.names = FALSE, digits = c(0,0,0,0)) |>
  remove_column(1) |>
  kableExtra::group_rows(index = table(df2$landuse)) |>
  # kableExtra::kable_paper("hover", full_width = F)
kable_classic(full_width = F, html_font = "Cambria")


#flextable ----
library(flextable)


pcolors <- palette.colors(length(unique(veg.str$landuse))+1, palette = "ggplot2")
pcolors <- pcolors[2:length(pcolors)]
pcolors <- c('white',pcolors,pcolors,pcolors)
thcols <- 1:length(unique(veg.str$landuse))
thcols <- 3*thcols+1
df2 <- veg.str.wide
df2$name <- factor(df2$name, levels = c('ht.max','tree','shrub','herb','moss'))
df2 <- df2[order(df2$name),]
df2$name <- c('Maximum Height (m)','Tree (%)','Shrub (%)','Herb (%)','Moss (%)')

repnames <- colnames(df2)
repnames <- stringr::str_split_fixed(repnames, '_', 2)
repnamesA <- repnames[,2]
repnamesB <- repnames[,1]
repdf <- data.frame(A=repnamesA, B=repnamesB, C=pcolors)
repdf <- repdf |> mutate(seq = 1:nrow(repdf))
repdf <- repdf |> arrange(A)
repnames <- paste0(repnames[,2],'_',repnames[,1])
colnames(df2) <- repnames 
df2 <- df2[,repdf$seq]
colnames(df2)[1]<-'Variable'

theme_design <- function(x) {
  x <- border_remove(x)
  std_border <- fp_border_default(width = 0.5, color = "black")
  thk_border <- fp_border_default(width = 2, color = "black")
  x <- fontsize(x, size = 10, part = "all")
  x <- font(x, fontname = "Cambria", part = "all")
  x <- align(x, align = "center", part = "all")
  x <- bold(x, bold = TRUE, part = "all")
  x <- bg(x, bg = "white", part = "body")
  x <- bg(x, bg = repdf$C, part = "header")
  x <- bg(x, bg = "white", part = "footer")
  x <- color(x, color = "black", part = "all")
  x <- padding(x, padding = 1, part = "all")
  x <- border_outer(x, part="all", border = thk_border )
  x <- border_inner_h(x, border = std_border, part="all")
  x <- border_inner_v(x, border = std_border, part="all")
  x <- vline(x, j = c(1,thcols), border = thk_border, part = "all")
  x <- set_table_properties(x, layout = "fixed")
  x
}
df2 |> 
  flextable() |> 
  separate_header() |> 
  autofit() |> theme_design()


#Species_Composition
taxon.fill <- merge(data.frame(group = unique(veg$landuse)), data.frame(taxon = unique(veg$taxon), Low = 0, RV = 0, High = 0)) |> mutate(type = vegnasis::fill.type(taxon)) |> unique() 
taxon.fill <- taxon.fill[,c('group','taxon', 'type', 'Low', 'RV', 'High')]

veg.comp.summary <-  veg  |> summary.ESIS(group='landuse', breaks = c(5), normalize = F,  
                                          lowerQ = 0, upperQ = 1) |> ungroup()
veg.comp.summary <- veg.comp.summary |> mutate(Low = cover.Low, RV=cover.mean, High=cover.High)
overstory <- veg.comp.summary |> subset(Top > 5, select = c("group","taxon", "type","Low","RV","High"))
#add missing rows
o2 <- subset(taxon.fill, taxon %in% overstory$taxon)
o2 <- subset(o2, !paste(taxon,group) %in% paste(overstory$taxon,overstory$group) )
overstory <- overstory |> rbind(o2)


allplots <- overstory |> group_by(taxon, type) |> summarise(group = "All Landuses", Low = min(Low), RV = mean(RV), High = max(High)) |> arrange(-RV )
factorgroup <- unique(overstory$group)
factortaxon <- allplots$taxon
overstory <- rbind(overstory, allplots)
overstory$taxon <- factor(overstory$taxon, levels = factortaxon)
overstory$group <- factor(overstory$group, levels = c(factorgroup,"All Landuses"))
overstory <- overstory |> arrange(group, taxon)

overstory |> 
  knitr::kable(row.names = FALSE, digits = c(1,1,1,1,1)) %>%
  remove_column(1) |> column_spec(1,italic=T) |>
  kableExtra::group_rows(index = table(overstory$group)) |>
  kable_classic(full_width = F, html_font = "Cambria")


#Flextable ---- 

overstory.wide <- overstory  |> mutate(Low = condRound1(Low), RV = condRound1(RV), High = condRound1(High)) |> tidyr::pivot_wider(names_from = group, values_from = c(Low,RV,High)) |> as.data.frame()

ngroups <- length(unique(overstory$group))
pcolors <- palette.colors(ngroups+1, palette = "ggplot2")
pcolors <- pcolors[2:length(pcolors)]
pcolors <- c('white','white',pcolors,pcolors,pcolors)
thcols <- 1:ngroups
thcols <- 3*thcols+2
df2 <- overstory.wide

repnames <- colnames(df2)
repnames <- stringr::str_split_fixed(repnames, '_', 2)
repnamesA <- repnames[,2]
repnamesB <- repnames[,1]
repdf <- data.frame(A=repnamesA, B=repnamesB, C=pcolors)
repdf <- repdf |> mutate(seq = 1:nrow(repdf), 
                         seq2 = c(1:2,(1:ngroups)+2,(1:ngroups)+2,(1:ngroups)+2))
repdf <- repdf |> arrange(seq2)
repnames <- paste0(repnames[,2],'_',repnames[,1])
colnames(df2) <- repnames 
df2 <- df2[,repdf$seq]
colnames(df2)[1:2]<- c('Taxon','Habit')

theme_design <- function(x) {
  x <- border_remove(x)
  std_border <- fp_border_default(width = 0.5, color = "black")
  thk_border <- fp_border_default(width = 2, color = "black")
  x <- fontsize(x, size = 10, part = "all")
  x <- font(x, fontname = "Cambria", part = "all")
  x <- italic(x, j=1, part = "body")
  x <- align(x, align = "center", part = "all")
  x <- align(x, align = "center", part = "header")
  x <- align(x, align = "left", part = "body", j=1)
  x <- align(x, align = "center", part = "body", j=2)
  x <- bold(x, bold = TRUE, part = "all")
  x <- bg(x, bg = "white", part = "body")
  x <- bg(x, bg = repdf$C, part = "header")
  x <- bg(x, bg = "white", part = "footer")
  x <- color(x, color = "black", part = "all")
  x <- padding(x, padding = 1, part = "all")
  x <- border_outer(x, part="all", border = thk_border )
  x <- border_inner_h(x, border = std_border, part="all")
  x <- border_inner_v(x, border = std_border, part="all")
  x <- vline(x, j = c(2,thcols), border = thk_border, part = "all")
  x <- set_table_properties(x, layout = "fixed")
  x
}
df2 |> 
  flextable() |> 
  separate_header() |> 
  autofit() |> theme_design()


#understory ----
understory <- veg.comp.summary |> subset(Top <= 5, select = c("group","taxon", "type", "Low","RV","High")) 
u2 <- subset(taxon.fill, taxon %in% understory$taxon)
u2 <- subset(u2, !paste(taxon,group) %in% paste(understory$taxon,understory$group))
understory <- understory |> rbind(u2)

allplots <- understory |> group_by(taxon, type) |> summarise(group = "All Landuses", Low = min(Low), RV = mean(RV), High = max(High)) |> arrange(-RV )
keeptaxa <- subset(allplots, High >= 10)$taxon
factorgroup <- unique(understory$group)
factortaxon <- allplots$taxon
understory <- rbind(understory, allplots)
understory$taxon <- factor(understory$taxon, levels = factortaxon)
understory$group <- factor(understory$group, levels = c(factorgroup,"All Landuses"))
understory <- understory |> arrange(group, taxon) |> subset(taxon %in% keeptaxa)

options(knitr.kable.NA = '-')
understory |> #mutate(Low = condRound1(Low), RV = condRound1(RV), High = condRound1(High)) |>
  knitr::kable(row.names = FALSE, digits = c(1,1,1,1,1)) %>% 
  remove_column(1) |> column_spec(1,italic=T) |>
  kableExtra::group_rows(index = table(understory$group)) |>
  kable_classic(full_width = F, html_font = "Cambria")



#understory flextable ----
understory.wide <- understory  |> mutate(Low = condRound1(Low), RV = condRound1(RV), High = condRound1(High)) |> tidyr::pivot_wider(names_from = group, values_from = c(Low,RV,High)) |> as.data.frame()

ngroups <- length(unique(understory$group))
pcolors <- palette.colors(ngroups+1, palette = "ggplot2")
pcolors <- pcolors[2:length(pcolors)]
pcolors <- c('white','white',pcolors,pcolors,pcolors)
thcols <- 1:ngroups
thcols <- 3*thcols+2
df2 <- understory.wide

repnames <- colnames(df2)
repnames <- stringr::str_split_fixed(repnames, '_', 2)
repnamesA <- repnames[,2]
repnamesB <- repnames[,1]
repdf <- data.frame(A=repnamesA, B=repnamesB, C=pcolors)
repdf <- repdf |> mutate(seq = 1:nrow(repdf), 
                         seq2 = c(1:2,(1:ngroups)+2,(1:ngroups)+2,(1:ngroups)+2))
repdf <- repdf |> arrange(seq2)
repnames <- paste0(repnames[,2],'_',repnames[,1])
colnames(df2) <- repnames 
df2 <- df2[,repdf$seq]
colnames(df2)[1:2]<- c('Taxon','Habit')

theme_design <- function(x) {
  x <- border_remove(x)
  std_border <- fp_border_default(width = 0.5, color = "black")
  thk_border <- fp_border_default(width = 2, color = "black")
  x <- fontsize(x, size = 10, part = "all")
  x <- font(x, fontname = "Cambria", part = "all")
  x <- italic(x, j=1, part = "body")
  x <- align(x, align = "center", part = "all")
  x <- align(x, align = "center", part = "header")
  x <- align(x, align = "left", part = "body", j=1)
  x <- align(x, align = "center", part = "body", j=2)
  x <- bold(x, bold = TRUE, part = "all")
  x <- bg(x, bg = "white", part = "body")
  x <- bg(x, bg = repdf$C, part = "header")
  x <- bg(x, bg = "white", part = "footer")
  x <- color(x, color = "black", part = "all")
  x <- padding(x, padding = 1, part = "all")
  x <- border_outer(x, part="all", border = thk_border )
  x <- border_inner_h(x, border = std_border, part="all")
  x <- border_inner_v(x, border = std_border, part="all")
  x <- vline(x, j = c(2,thcols), border = thk_border, part = "all")
  x <- set_table_properties(x, layout = "fixed")
  x
}
df2 |> 
  flextable() |> 
  separate_header() |> 
  autofit() |> theme_design()

```
